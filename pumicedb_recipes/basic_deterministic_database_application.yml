- import_playbook: ../raft_recipes/healthy_raftserver_cluster_type2.yml

- name: "basic_deterministic_database_application"
  hosts: localhost
  connection: local
  vars:
    recipe_name: "basic_deterministic_db_app"
    parent: "healthy_raftserver_cluster_type2"
    requirement: "pumicedb"
    num_of_app_uuids: 99
    num_of_writes: 10
    no_of_writes: 1
    column_family: "PMDBTS_CF"

  tasks:
  - block:
    - name: "{{ recipe_name }}: Check if parent recipe failed"
      debug: msg="Check if parent recipe {{ parent }} failed"
      failed_when: terminate_recipe == true
    
    # Check the app type
    - name: "{{ recipe_name }}: Check if the app_type is covid."
      vars:
        app_type: "{{ app_type }}"
      debug:
        msg: "app_type should be pumicedb"
      failed_when: (app_type != "pumicedb")

    - name: "{{ recipe_name }}: Check if coalesced write flag is set before starting to run the recipe."
      debug: msg="Check if coalesced write flag is set before starting to run the recipe."
      failed_when: coalesced_wr | int != 1

    - name: "{{ recipe_name }}: Verifying recipe compatibility requirements."
      include_role:
         name: common
         tasks_from: recipe_compatibility_requirement

    - name: "{{ recipe_name }}: Get follower-stats from leader peer after restart."
      include_role:
        name: common
        tasks_from: get_follower_stats

    # Start a client.    

    - name: "{{ recipe_name }}: Get unused client uuid for starting the client"
      include_role:
        name: common
        tasks_from: get_new_client_uuid
      register: client_uuid

    - name: "{{ recipe_name }}: Start the client: {{ client_uuid.stdout }}"
      include_role:
         name: common
         tasks_from: start_client
      vars:
         ClientUUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Verify leader is viable."
      include_role:
        name: common
        tasks_from: verify_leader_viable
      vars:
        ClientUUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Verify client values."
      vars:
        client_leader_uuid: "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, '/raft_client_root_entry/0/leader-uuid') }}"
        client_state: "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, '/raft_client_root_entry/0/state') }}"
        client_last_req_ack: "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, '/raft_client_root_entry/0/last-request-ack') }}"
      debug:
        msg: "Get the values from client for verification."
      no_log: True
      failed_when: >
        (client_leader_uuid['/0/leader-uuid'] != LeaderUUID['/0/leader-uuid']) or
        (client_state['/0/state'] != "client") or
        (client_last_req_ack['/0/last-request-ack'] != "Thu Jan 01 00:00:00 UTC 1970")

    # Get pre-write values before normal set of writes.

    - name: "{{ recipe_name }}: Get pre-write info from all servers."
      include_role:
        name: common
        tasks_from: get_all_values_from_all_peers

    - name: "{{ recipe_name }}: Print pre-write values of all servers."
      debug: 
        msg: "{{ get_values_from_all }}"

    - name: "{{ recipe_name }}: Get set of required number of app_uuids."
      include_role:
        name: common
        tasks_from: create_app_uuid_set
      vars:
        number_of_apps: "{{ num_of_app_uuids }}"

    # Perform normal set of writes (without coalesced writes fault injection.)

    - name: "{{ recipe_name }}: Perform write operations on the client."
      include_role:
         name: common
         tasks_from: perform_writes
      vars:
        pmdb_apps: "{{ pmdb_app_uuids }}"
        constant_number_of_writes: "{{ num_of_writes }}"
        ClientUUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Wait until write status gets updated from client."
      vars:
        stage: "wait_for_write_status"
        cmd_str:
           - "/pumice_db_test_client/pmdb-test-apps/*/status"
      debug:
        msg: "Wait until write status gets updated"
      until: lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, cmd_str)['/*/status'] == "Success"
      retries: 100
      delay: 2

    # Wait until write completes from client

    - name: "{{ recipe_name }}: Wait until write completes from client."
      vars:
        stage: "wait_for_write_compltn"
        write_key:
          - "/pumice_db_test_client/pmdb-test-apps/*/pmdb-seqno"
      debug:
        msg: "Waiting for client to finish writing"
      until: lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, write_key)['/*/pmdb-seqno'] == (num_of_writes - 1)
      retries: 100
      delay: 2

    - name: "{{ recipe_name }}: Verify client parameters."
      include_role:
        name: common
        tasks_from: verify_client_parameters
      vars:
        Client_UUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Verify all RocksDB key-values from all nodes."
      include_role:
        name: common
        tasks_from: verify_rocksdb_key_values_for_all

    # Reset the pmdb_app_uuids list.

    - name: "Reset pmdb_app_uuids before creating new app UUID set."
      set_fact:
        pmdb_app_uuids: []

    - name: "{{ recipe_name }}: Get set of required number of app_uuids."
      include_role:
        name: common
        tasks_from: create_app_uuid_set
      vars:
        number_of_apps: "{{ num_of_app_uuids }}"

    # Start a new client.

    - name: "{{ recipe_name }}: Generate New Client UUID"
      shell: "/usr/bin/uuid"
      register: client_uuid

    - name: "{{ recipe_name }}: Start the client: {{ client_uuid.stdout }}"
      include_role:
         name: common
         tasks_from: start_client
      vars:
         ClientUUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Verify leader is viable."
      include_role:
        name: common
        tasks_from: verify_leader_viable
      vars:
        ClientUUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Verify client values."
      vars:
        client_leader_uuid: "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, '/raft_client_root_entry/0/leader-uuid') }}"
        client_state: "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, '/raft_client_root_entry/0/state') }}"
        client_last_req_ack: "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, '/raft_client_root_entry/0/last-request-ack') }}"
      debug:
        msg: 
          - "Get the values from client for verification."
          - "{{ client_leader_uuid['/0/leader-uuid'] }}"
          - "{{ LeaderUUID['/0/leader-uuid'] }}"
      no_log: False
      failed_when: >
        (client_leader_uuid['/0/leader-uuid'] != LeaderUUID['/0/leader-uuid']) or
        (client_state['/0/state'] != "client") or
        (client_last_req_ack['/0/last-request-ack'] != "Thu Jan 01 00:00:00 UTC 1970") 

    # Get the pre-write values before performing coalesced writes operation.

    - name: "{{ recipe_name }}: Get pre-write info from all servers before performing coalesced writes."
      include_role:
        name: common
        tasks_from: get_all_values_from_all_peers

    - name: "{{ recipe_name }}: Save pre-write values of all servers before performing coalesced writes."
      set_fact:
        pre_coalesced_wr: "{{ get_values_from_all }}"

    - name: "{{ recipe_name }}: Print pre-write values of all servers before performing coalesced writes."
      debug: 
        msg: "{{ pre_coalesced_wr }}"

    - name: "{{ recipe_name }}: Get follower-stats from leader peer after restart."
      include_role:
        name: common
        tasks_from: get_follower_stats

    - name: "{{ recipe_name }}: Verify leader is viable."
      include_role:
        name: common
        tasks_from: verify_leader_viable
      vars:
        ClientUUID: "{{ client_uuid.stdout }}"

    # Enable coalesced writes fault injection.

    - name: "{{ recipe_name }}: Enable fault injection for coalesced writes."
      include_role:
        name: common
        tasks_from: set_fault_injection_and_verify
      vars:
        ServerUUID: "{{ LeaderUUID['/0/leader-uuid'] }}"
        fault_injection_name: "coalesced_writes"

    - name: "{{ recipe_name }}: Perform write operations on the client."
      include_role:
         name: common
         tasks_from: perform_writes
      vars:
        pmdb_apps: "{{ pmdb_app_uuids }}"
        constant_number_of_writes: "{{ no_of_writes }}"
        ClientUUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Verify the value of coalesced items pending."
      vars:
        stage: coalesced_pending
        pending_coalesced_writes: "{{ lookup('niova_ctlrequest', 'lookup', LeaderUUID['/0/leader-uuid'], '/raft_root_entry/0/coalesce-items-pending') }}"
      debug:
        msg: "{{ pending_coalesced_writes }}"
      no_log: False
      failed_when: >
        ((pending_coalesced_writes['/0/coalesce-items-pending'] | int) != num_of_app_uuids)

    - name: "{{ recipe_name }}: Remove fault injection from leader and verify."
      vars:
        cmd: "enabled@false"
        where: "/fault_injection_points/name@coalesced_writes"
        leader: "{{ LeaderUUID['/0/leader-uuid'] }}"
        # Step 1: Disable the fault injection
        remove_fault_inject: "{{ lookup('niova_ctlrequest', 'apply_cmd', leader, cmd, where) }}"
        # Step 2: Fetch the updated array
        fault_points: "{{ lookup('niova_ctlrequest', 'lookup', leader, '/fault_injection_points') }}"
        # Step 3: Safely extract coalesced_writes enabled flag (if exists)
        coalesced_write_fi_list: >-
          {{
            fault_points.get('//fault_injection_points', [])
            | selectattr('name', 'equalto', 'coalesced_writes')
            | map(attribute='enabled')
            | list
          }}
        coalesced_write_fi: "{{ coalesced_write_fi_list[0] | default(false) }}"
      debug:
        msg:
          - "Removed fault injection result: {{ remove_fault_inject }}"
          - "Coalesced write FI entries found: {{ coalesced_write_fi_list | length }}"
          - "Coalesced write FI enabled flag: {{ coalesced_write_fi }}"
      failed_when: coalesced_write_fi | bool == true
      no_log: False

    - name: "{{ recipe_name }}: Wait until write status gets updated from client."
      vars:
        stage: "wait_for_write_status"
        cmd_str:
           - "/pumice_db_test_client/pmdb-test-apps/*/status"
      debug:
        msg: "Wait until write status gets updated"
      until: lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, cmd_str)['/*/status'] == "Success"
      retries: 100
      delay: 2

    # Wait until write completes from client

    - name: "{{ recipe_name }}: Wait until write completes from client."
      vars:
        stage: "wait_for_write_compltn"
        write_key:
          - "/pumice_db_test_client/pmdb-test-apps/*/pmdb-seqno"
      debug:
        msg: 
          - "Waiting for client to finish writing"
          - "{{ lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, write_key)['/*/pmdb-seqno'] }}"
      until: lookup('niova_ctlrequest', 'lookup', client_uuid.stdout, write_key)['/*/pmdb-seqno'] == no_of_writes - 1
      retries: 100
      delay: 2

    - name: "{{ recipe_name }}: Verify client parameters."
      include_role:
        name: common
        tasks_from: verify_client_parameters
      vars:
        Client_UUID: "{{ client_uuid.stdout }}"

    - name: "{{ recipe_name }}: Get post-write info from all servers."
      include_role:
        name: common
        tasks_from: get_all_values_from_all_peers

    - name: "{{ recipe_name }}: Print post-write values of all servers."
      debug: 
        msg: "{{ get_values_from_all }}"

    - name: "{{ recipe_name }}: Verify all RocksDB key-values from all nodes."
      include_role:
        name: common
        tasks_from: verify_rocksdb_key_values_for_all

    - name: "{{ recipe_name }}: Verify data consistency across all servers."
      debug:
        msg: "{{ lookup('rocksdb_util', 'verify_consistency') }}"

    rescue:
      - name: "Recipe: {{ recipe_name }} failed"
        set_fact:
           terminate_recipe: true 