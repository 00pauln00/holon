- name: "atomicity_in_apply"
  hosts: localhost
  connection: local
  vars:
    recipe_name: "atomicity_in_apply"
    csv_file1: "csv_data1.csv"
    csv_file2: "csv_data2.csv"
    num_writes: 10
    start_key: 1000

  tasks:
  - block:
      ####################################################################
      # 0. CHECK APP TYPE
      ####################################################################
      - name: "{{ recipe_name }}: Check if the app_type is covid."
        vars:
          app_type: "{{ app_type }}"
        debug:
          msg: "app_type should be covid"
        failed_when: (app_type != "covid")

      ####################################################################
      # 1. START SERVERS
      ####################################################################
      - name: "{{ recipe_name }}: Print the UUIDs of all the servers."
        include_role:
          name: common
          tasks_from: get_server_uuid_info

      - name: "{{ recipe_name }}: Start all the servers in the cluster."
        include_role:
          name: common
          tasks_from: start_server_golang
        vars:
          ServerUUID: "{{ NonRunningServers[item] }}"
        loop: "{{ range(0, NonRunningServers | length) | list }}"

      ####################################################################
      # 2. START CLIENT
      ####################################################################
      - name: "{{ recipe_name }}: Get unused client uuid for starting the client."
        include_role:
          name: common
          tasks_from: get_new_client_uuid
        register: client_uuid

      ####################################################################
      # 3. WAIT FOR LEADER
      ####################################################################
      - name: "Wait until leader election happens."
        vars:
          stage: "wait_leader_election"
        debug:
          msg: "Waiting for leader election"
        until: >
          lookup('niova_ctlrequest', 'lookup', NonRunningServers[item], '/raft_root_entry/0/leader-uuid') != "null"
        retries: 10
        delay: 1
        loop: "{{ range(0, NonRunningServers | length) | list }}"

      - name: "{{ recipe_name }}: Get the leader UUID."
        include_role:
          name: common
          tasks_from: get_leader_uuid
        register: leader_info

      - name: "{{ recipe_name }}: Get leader UUID directly."
        vars:
          raft_key: "/raft_root_entry/0/leader-uuid"
          leader_dict: "{{ lookup('niova_ctlrequest', 'lookup', NonRunningServers, raft_key) | first }}"
        set_fact:
          current_leader_uuid: "{{ leader_dict['/0/leader-uuid'] }}"

      - name: "{{ recipe_name }}: Print the Leader UUID."
        debug:
          msg: "{{ current_leader_uuid }}"

      ####################################################################
      # 4. FIRST SET OF MONOTONIC WRITES
      ####################################################################
      - name: "{{ recipe_name }}: Generate App UUID for monotonic writes."
        shell: "/usr/bin/uuid"
        register: app_uuid

      - name: "{{ recipe_name }}: Get the path for csv file."
        set_fact:
          NIOVA_BIN_PATH: "{{ lookup('env','NIOVA_BIN_PATH') }}"

      - name: "{{ recipe_name }}: Create monotonic CSV file for writes."
        copy:
          content: |
            location,iso_code,date,total_vaccinations,people_vaccinated,people_fully_vaccinated,daily_vaccinations_raw,daily_vaccinations,total_vaccinations_per_hundred,people_vaccinated_per_hundred,people_fully_vaccinated_per_hundred,daily_vaccinations_per_million,
            {{ start_key }},AFG,16-03-2021,54000,54000,,,2862,0.14,0.14,,74,
            {{ start_key + 1 }},OWID_AFR,03-06-2021,34365454,25234549,8914235,278659,668496,2.56,1.88,0.66,499,
            {{ start_key + 2 }},ALB,18-02-2021,3049,2438,611,1348,254,0.11,0.08,0.02,88,
            {{ start_key + 3 }},AND,08-03-2021,3611,2439,1172,,108,4.67,3.16,1.52,1398,
            {{ start_key + 4 }},DZA,19-02-2021,75000,,,,3748,0.17,,,85,
            {{ start_key + 5 }},AGO,29-03-2021,130750,130750,,,8057,0.4,0.4,,245,
            {{ start_key + 6 }},ARM,31-03-2021,565,565,,,,0.02,0.02,,,
            {{ start_key + 7 }},AIA,22-04-2021,6898,6115,783,,106,45.98,40.76,5.22,7066,
            {{ start_key + 8 }},ABW,10-04-2021,41096,29197,11899,,1278,38.49,27.35,11.14,11970,
            {{ start_key + 9 }},ATG,31-05-2021,50329,33463,16866,,1278,51.39,34.17,17.22,13050,
          dest: "{{ NIOVA_BIN_PATH }}/{{ csv_file1 }}"

      - name: "{{ recipe_name }}: Write monotonic keys to COVID Application."
        vars:
          input_param: {
                async_mode: False     # run in sync mode
          }
          stage: "CovidWriteMulti"
          cmd: "WriteMulti#{{ NIOVA_BIN_PATH }}/{{ csv_file1 }}#{{ recipe_name }}_{{ stage }}"
          WriteMultiValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, input_param) }}"
        debug:
          msg: "write monotonic entries"
        with_items:
          - "{{ WriteMultiValue }}"
        register: WriteMulti
        no_log: false

      ####################################################################
      # 5. SECOND SET OF MONOTONIC WRITES
      ####################################################################

      - name: "{{ recipe_name }}: Create monotonic CSV file for second set of writes."
        copy:
          content: |
            location,iso_code,date,total_vaccinations,people_vaccinated,people_fully_vaccinated,daily_vaccinations_raw,daily_vaccinations,total_vaccinations_per_hundred,people_vaccinated_per_hundred,people_fully_vaccinated_per_hundred,daily_vaccinations_per_million,
            {{ start_key + 10 }},AUS,15-03-2021,120000,95000,25000,3000,5000,4.8,3.7,1.1,1520,
            {{ start_key + 11 }},AUT,20-03-2021,87500,64000,23500,2200,4300,5.2,3.8,1.4,980,
            {{ start_key + 12 }},AZE,28-03-2021,60500,48200,12300,1800,2900,3.4,2.7,0.7,1100,
            {{ start_key + 13 }},BHS,02-04-2021,32000,24500,7500,900,1500,8.1,6.2,1.9,890,
            {{ start_key + 14 }},BHR,05-04-2021,76000,58000,18000,2600,3700,12.3,9.4,2.9,1440,
            {{ start_key + 15 }},BGD,09-04-2021,210000,166000,44000,7200,9500,1.7,1.3,0.4,1270,
            {{ start_key + 16 }},BRB,12-04-2021,28750,20900,7850,1100,1500,9.8,7.1,2.7,1340,
            {{ start_key + 17 }},BLR,18-04-2021,97000,71400,25600,3400,4900,10.1,7.4,2.7,1420,
            {{ start_key + 18 }},BEL,25-04-2021,134000,100200,33800,4500,6900,11.5,8.6,2.9,1590,
            {{ start_key + 19 }},BLZ,02-05-2021,24300,17600,6700,800,1300,6.4,4.6,1.8,930,
            {{ start_key + 20 }},BOL,08-05-2021,86500,65000,21500,2600,4100,5.7,4.3,1.4,1050,
            {{ start_key + 21 }},BRA,15-05-2021,452000,355000,97000,13500,17500,6.2,4.9,1.3,2100,
            {{ start_key + 22 }},BRN,20-05-2021,19400,14200,5200,700,1200,7.1,5.2,1.9,870,
            {{ start_key + 23 }},BGR,28-05-2021,65500,49800,15700,1900,3200,5.5,4.2,1.3,1150,
            {{ start_key + 24 }},BFA,03-06-2021,30700,22100,8600,1000,1600,3.8,2.9,0.9,940,
            {{ start_key + 25 }},BDI,10-06-2021,22900,16800,6100,800,1300,4.2,3.2,1.0,910,
            {{ start_key + 26 }},KHM,17-06-2021,74300,56200,18100,2400,3700,7.9,5.9,2.0,1280,
            {{ start_key + 27 }},CMR,24-06-2021,98400,75600,22800,3200,4800,8.3,6.4,1.9,1330,
            {{ start_key + 28 }},CAN,01-07-2021,152000,115000,37000,5200,7200,9.6,7.2,2.4,1750,
            {{ start_key + 29 }},CPV,08-07-2021,18400,13400,5000,600,900,6.7,4.9,1.8,880,
          dest: "{{ NIOVA_BIN_PATH }}/{{ csv_file2 }}"

      - name: "{{ recipe_name }}: Write monotonic keys to COVID Application."
        vars:
          input_param: {
                async_mode: True     # run in async mode
          }
          stage: "CovidWriteMulti2"
          cmd: "WriteMulti#{{ NIOVA_BIN_PATH }}/{{ csv_file2 }}#{{ recipe_name }}_{{ stage }}"
          result: "{{ lookup('app_cmd', cmd, client_uuid.stdout, input_param) }}"
        debug:
          msg: "Launched async multiwrite: {{ result }}"

      - pause:
          seconds: 2

      ####################################################################
      # 6. KILL THE LEADER
      ####################################################################
      
      - name: "{{ recipe_name }}: Kill the leader while writes are in progress." 
        debug: 
          msg: "{{ lookup('niova_raftprocess', 'kill', current_leader_uuid) }}" 
        no_log: false

      ####################################################################
      # 7. VERIFY PERSISTENCE
      ####################################################################

      - name: "{{ recipe_name }}: Verify if the recent key is persisted."
        include_role:
          name: common
          tasks_from: verify_persistence
        vars:
          leader_uuid: "{{ current_leader_uuid }}"
        register: key_persistence_result

      ####################################################################
      # 8. LEADER CHANGE VERIFICATION
      ####################################################################
      
      - name: "{{ recipe_name }}: Verify the new leader, commit-idx and term values."
        vars:
          RunningServers: "{{ NonRunningServers | difference([current_leader_uuid]) }}"
        debug:
          msg:
            - "{{ RunningServers[item] }}"
            - "{{ lookup('niova_ctlrequest', 'lookup', RunningServers[item], '/raft_root_entry/0/leader-uuid') }}"
            - "{{ lookup('niova_ctlrequest', 'lookup', RunningServers[item], '/raft_root_entry/0/commit-idx') }}"
            - "{{ lookup('niova_ctlrequest', 'lookup', RunningServers[item], '/raft_root_entry/0/term') }}"
        loop: "{{ range(0, RunningServers | length) | list }}"
      
    rescue:
      - name: "Recipe: {{ recipe_name }} failed."
        set_fact:
          terminate_recipe: true
