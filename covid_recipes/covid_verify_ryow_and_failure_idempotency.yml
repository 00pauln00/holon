- name: "rmw"
  hosts: localhost
  connection: local
  vars:
    recipe_name: "rmw"
    parent: None
    uid: "{{ app_uuid.stdout }}:0:0:0:0"

  tasks:
  - block:
      # check for the app_type
     - name: "{{ recipe_name }}: Check if the app_type is covid"
       vars:
         app_type: "{{ app_type}}"
       debug:
         msg: "app_type should be covid"
       failed_when:
         (app_type != "covid")

       # start the servers
     - name: "{{ recipe_name }}: Print the UUIDs of all the servers"
       include_role:
          name: common
          tasks_from: get_server_uuid_info

     - name: "{{ recipe_name }}: Start all the servers in the cluster"
       include_role:
         name: common
         tasks_from: start_server_golang
       vars:
         ServerUUID: "{{ NonRunningServers[item] }}"
       loop: "{{ range(0, NonRunningServers | length) | list }}"
    
     - name: "{{ recipe_name }}: Follower"
       include_role:
         name: common
         tasks_from: get_follower_stats
     
     ######################################################################
     ############# Verify read-your-own-writes gaurantee ##################
     ######################################################################
     
     - name: "{{ recipe_name }}: Apply fault injection on leader and verify."
       include_role:
         name: common
         tasks_from: set_fault_injection_and_verify
       vars:
         ServerUUID: "{{ LeaderUUID['/0/leader-uuid'] }}"
         fault_injection_name: "coalesced_writes"
       
       # start the client
     - name: "{{ recipe_name }}: Get unused client uuid for starting the client"
       include_role:
         name: common
         tasks_from: get_new_client_uuid
       register: client_uuid

       # generate rncui
     - name: "{{ recipe_name }}: Generate App UUID"
       shell: "/usr/bin/uuid"
       register: app_uuid
     
     - name: "{{ recipe_name}}: Write the single key-value pair to COVID Application"
       vars:
         stage: "CovidWriteOne"
         cmd: "WriteOne#{{ app_uuid.stdout }}:0:0:0:0#Africa#OWID_AFR#5000#2000#{{ recipe_name }}_{{ stage }}"
         WriteOneValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, 1) }}"
      
       # generate rncui
     - name: "{{ recipe_name }}: Generate App UUID"
       shell: "/usr/bin/uuid"
       register: app_uuid

     - name: "{{ recipe_name}}: Write the single key-value pair to COVID Application"
       vars:
         stage: "CovidWriteTwo"
         cmd: "WriteOne#{{ app_uuid.stdout }}:0:0:0:0#Africa#OWID_AFR#2000#1000#{{ recipe_name }}_{{ stage }}"
         WriteOneValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, 1) }}"
    
     - name: "Sleep for 5 seconds"
       pause:
         seconds: 5
      
      #Remove fault injection from leader
     - name: "{{ recipe_name }}: Apply cmd to remove fault injection from the leader."
       vars:
         stage: "recipe_cleanup"
         cmd: "enabled@false"
         where: "/fault_injection_points/name@coalesced_writes"
         remove_fault_inject: "{{ lookup('niova_ctlrequest', 'apply_cmd', LeaderUUID['/0/leader-uuid'], cmd, where) }}"
       debug:
         msg: "{{ remove_fault_inject }}"
       no_log: True

     - name: "Sleep for 5 seconds"
       pause:
         seconds: 5

     # read single entry
     - name: "{{ recipe_name}}: Read to the written key"
       vars:
         stage: "CovidReadOne"
         cmd: "ReadOne#Africa#{{ app_uuid.stdout }}:0:0:0:0#{{ recipe_name }}_{{ stage }}"
         ReadOneValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, wantlist=True) }}"
       debug:
         msg: "read single entry"
       with_items:
         - "{{ ReadOneValue }}"
       register: ReadOne
       no_log: True

       # compare read and write
     - name: "{{ recipe_name }}: Verify the results for read-your-own-write guarantee"
       vars:
        OldLeader_rdrqst: "{{ ReadOne['results'][0]['item']['response'][uid] }}"
       debug:
        msg: "compare read and write"
       failed_when: >
         (OldLeader_rdrqst['Location'] != "Africa") or
         (OldLeader_rdrqst['IsoCode'] != "OWID_AFR") or
         (OldLeader_rdrqst['PeopleVaccinated'] != "3000") or
         (OldLeader_rdrqst['TotalVaccinations'] != "7000")
    
     ######################################################################
     ############ Verify failure idempotency gaurantee 1 ##################
     ######################################################################
     
     #Enable coalesced_writes fault injection on the leader
     - name: "{{ recipe_name }}: Apply fault injection on leader and verify."
       include_role:
         name: common
         tasks_from: set_fault_injection_and_verify
       vars:
         ServerUUID: "{{ LeaderUUID['/0/leader-uuid'] }}"
         fault_injection_name: "coalesced_writes"

     - name: "{{ recipe_name}}: Write the single key-value pair to COVID Application"
       vars:
         stage: "CovidWriteOne"
         cmd: "WriteOne#{{ app_uuid.stdout }}:0:0:0:1#India#OWID_IND#5000#2000#{{ recipe_name }}_{{ stage }}"
         WriteOneValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, 1) }}"
       debug:
         msg: "write single entry {{ WriteOneValue }}"
     
     # Set raft_server_fail_partial_apply fault injection on a follower
     - name: "{{ recipe_name }}: Apply fault injection on a follower node and verify."
       include_role:
         name: common
         tasks_from: set_fault_injection_and_verify
       vars:
         ServerUUID: "{{ FollowerUUIDs[0] }}"
         fault_injection_name: "raft_server_fail_partial_apply"

     #Remove coalesced_writes fault injection from the leader
     - name: "{{ recipe_name }}: Apply cmd to remove fault injection from the leader."
       vars:
         stage: "recipe_cleanup"
         cmd: "enabled@false"
         where: "/fault_injection_points/name@coalesced_writes"
         remove_fault_inject: "{{ lookup('niova_ctlrequest', 'apply_cmd', LeaderUUID['/0/leader-uuid'], cmd, where) }}"
       debug:
         msg: "{{ remove_fault_inject }}"
       no_log: True

     - name: "Sleep for 5 seconds"
       pause:
         seconds: 5

     # Start the failed follower
     - name: "{{ recipe_name }}: Start the stopped follower server"
       include_role:
        name: common
        tasks_from: start_server_golang
       vars:
        ServerUUID: "{{ FollowerUUIDs[0] }}"

     #Check the data of follower
     - name: "{{ recipe_name }}: Verify if the recent key is persisted"
       vars:
        rdval: "{{ lookup('verify_rocksdb', FollowerUUIDs[0], 'PMDBTS_CF', 'India', wantlist=True) }}"
       debug:
        msg: "Value read from follower DB: {{ rdval }}"
       failed_when: >
          (rdval is not defined) or
          (rdval[0] != "OWID_IND") or
          (rdval[1] != "5000") or
          (rdval[2] != "2000")
    
    ######################################################################
     ############ Verify failure idempotency gaurantee 2 ##################
     ######################################################################
     
     #Enable coalesced_writes fault injection on the leader
     - name: "{{ recipe_name }}: Apply fault injection on leader and verify."
       include_role:
         name: common
         tasks_from: set_fault_injection_and_verify
       vars:
         ServerUUID: "{{ LeaderUUID['/0/leader-uuid'] }}"
         fault_injection_name: "coalesced_writes"
       
     - name: "{{ recipe_name}}: Write the single key-value pair to COVID Application"
       vars:
         stage: "CovidWriteOne"
         cmd: "WriteOne#{{ app_uuid.stdout }}:0:0:0:2#America#OWID_AM#5000#2000#{{ recipe_name }}_{{ stage }}"
         WriteOneValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, 1) }}"
       debug:
         msg: "write single entry {{ WriteOneValue }}"

       # generate rncui
     - name: "{{ recipe_name }}: Generate App UUID"
       shell: "/usr/bin/uuid"
       register: app_uuid

     - name: "{{ recipe_name}}: Write the single key-value pair to COVID Application"
       vars:
         stage: "CovidWriteOne"
         cmd: "WriteOne#{{ app_uuid.stdout }}:0:0:0:0#Australia#OWID_AUS#5000#2000#{{ recipe_name }}_{{ stage }}"
         WriteOneValue: "{{ lookup('app_cmd', cmd, client_uuid.stdout, 1) }}"
       debug:
         msg: "write single entry {{ WriteOneValue }}"

     
     # Set raft_server_fail_partial_apply fault injection on a follower
     - name: "{{ recipe_name }}: Apply fault injection on a follower node and verify."
       include_role:
         name: common
         tasks_from: set_fault_injection_and_verify
       vars:
         ServerUUID: "{{ FollowerUUIDs[0] }}"
         fault_injection_name: "raft_server_fail_partial_apply"

     #Remove coalesced_writes fault injection from the leader
     - name: "{{ recipe_name }}: Apply cmd to remove fault injection from the leader."
       vars:
         stage: "recipe_cleanup"
         cmd: "enabled@false"
         where: "/fault_injection_points/name@coalesced_writes"
         remove_fault_inject: "{{ lookup('niova_ctlrequest', 'apply_cmd', LeaderUUID['/0/leader-uuid'], cmd, where) }}"
       debug:
         msg: "{{ remove_fault_inject }}"
       no_log: True

     - name: "Sleep for 5 seconds"
       pause:
         seconds: 5

     # Start the failed follower
     - name: "{{ recipe_name }}: Start the stopped follower server"
       include_role:
        name: common
        tasks_from: start_server_golang
       vars:
        ServerUUID: "{{ FollowerUUIDs[0] }}"
     
     - name: "Sleep for 5 seconds"
       pause:
         seconds: 5

     #Check the data of follower
     - name: "{{ recipe_name }}: Verify if the recent key is persisted"
       vars:
        rdval: "{{ lookup('verify_rocksdb', FollowerUUIDs[0], 'PMDBTS_CF', 'America', wantlist=True) }}"
       debug:
        msg: "Value read from follower DB: {{ rdval }}"
       failed_when: >
          (rdval is not defined) or
          (rdval[0] != "OWID_AM") or
          (rdval[1] != "5000") or
          (rdval[2] != "2000")
     - name: "{{ recipe_name }}: Verify if the recent key is persisted"
       vars:
        rdval: "{{ lookup('verify_rocksdb', FollowerUUIDs[0], 'PMDBTS_CF', 'Australia', wantlist=True) }}"
       debug:
        msg: "Value read from follower DB: {{ rdval }}"
       failed_when: >
          (rdval is not defined) or
          (rdval[0] != "OWID_AUS") or
          (rdval[1] != "5000") or
          (rdval[2] != "2000")

    rescue:
      - name: "Recipe: {{ recipe_name }} failed"
        set_fact:
          terminate_recipe: true
