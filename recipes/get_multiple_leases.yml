- name: "get multiple leases"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "get_multiple_leases"
     parent: None
     no_of_leases: 10

  tasks:
  - block:
    - name: "{{ recipe_name }}: Get the non-running peers list to select first peer to start"
      include_role:
        name: common
        tasks_from: get_server_uuid_info

    - name: "Start 5 peers in the cluster"
      include_role:
        name: common
        tasks_from: start_server
      vars:
        ServerUUID: "{{ NonRunningServers[item] }}"
      loop: "{{ range(0, NonRunningServers | length) | list }}"

    - name: "{{ recipe_name }}: Get the running peers list."
      include_role:
        name: common
        tasks_from: get_server_uuid_info

    - name: Generate new resource
      shell: "/usr/bin/uuid"
      register: resourceUUID

    - name: Generate new client
      shell: "/usr/bin/uuid"
      register: clientUUID

    - name: "Get multiple client uuids."
      include_role:
        name: common
        tasks_from: get_multiple_client_uuids
      loop: "{{ range(0, no_of_leases) | list }}"

    - name: "Get multiple resource uuids."
      include_role:
        name: common
        tasks_from: get_multiple_resource_uuids
      loop: "{{ range(0, no_of_leases) | list }}"

    - debug:
        msg: "{{ resourceUUIDS }}"

    - debug:
        msg: "{{ ClientUUIDS }}"

    - name: "Perform multiple 'get_lease' operation"
      include_role:
        name: common
        tasks_from: get_lease
      vars:
         ClientUUID: '{{ ClientUUIDS[idx] }}'
         resourceUUID: '{{ resourceUUIDS[idx] }}'
         outfilename: '{{ resourceUUIDS[idx] }}' 
      loop: "{{ range(0, no_of_leases) | list }}"
      loop_control: 
         loop_var: idx

    - debug:
        msg: "{{getLease}}"
 
    - name: "Perform multiple 'get_lease' operation"
      include_role:
        name: common
        tasks_from: lookup_lease
      vars:
         ClientUUID: '{{ ClientUUIDS[idx] }}'
         resourceUUID: '{{ resourceUUIDS[idx] }}'
         outfilename: '{{ resourceUUIDS[idx] }}'
      loop: "{{ range(0, no_of_leases) | list }}"
      loop_control:
         loop_var: idx
  
    - debug:
        msg: "{{ lookupLease }}"

