- import_playbook: basic_lease_operation_all.yml

- name: "Verify_get_lease_functionality"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "verify_get_lease_functionality"
     parent: basic_lease_operation_all

  tasks:
  - block:
    - name: "{{ recipe_name }}: Get the non-running peers list to select first peer to start"
      include_role:
        name: common
        tasks_from: get_server_uuid_info

    - name: Generate new resource
      shell: "/usr/bin/uuid"
      register: resourceUUID

    - name: Generate new client
      shell: "/usr/bin/uuid"
      register: clientUUID1

    - name: "{{ recipe_name }}: Perform 'get_lease' operation from client 1 to resource 1."
      vars:
         input_param: {
                'client': '{{ clientUUID1.stdout }}',
                'resource': '{{ resourceUUID.stdout }}',
                'outFileName': 'get_lease_{{ resourceUUID.stdout }}'
                 }
         leaseApp: "{{ lookup('lease_feature', 'GET', input_param, wantlist=True) }}"
      debug:
         msg: "get lease operation"
      with_items:
          - "{{ leaseApp }}"
      register: getLease_client1

    - name: "{{ recipe_name }}: Verify outfile status"
      debug:
        msg: "Check write outfile status: {{ getLease_client1['results'][0]['item']['outfile_status'] }}"
       #no_log: true
      failed_when: >
         (getLease['results'][0]['item']['outfile_status'] != 0)

    - name: Generate new client
      shell: "/usr/bin/uuid"
      register: clientUUID2

    - name: "{{ recipe_name }}: Perform 'get_lease' operation from client 2 to resource 1."
      vars:
         input_param: {
                'client': '{{ clientUUID2.stdout }}',
                'resource': '{{ resourceUUID.stdout }}',
                'outFileName': 'get_lease_{{ resourceUUID.stdout }}'
                 }
         leaseApp: "{{ lookup('lease_feature', 'GET', input_param, wantlist=True) }}"
      debug:
         msg: "get lease operation"
      with_items:
          - "{{ leaseApp }}"
      register: getLease_client2

    - name: "{{ recipe_name }}: Verify outfile status"
      debug:
        msg: "Check write outfile status: {{ getLease_client2['results'][0]['item']['outfile_status'] }}"
       #no_log: true
      failed_when: >
         (getLease['results'][0]['item']['outfile_status'] != 0)

    #TO DO 
    # only one client will be successfully able to mount the resource. 

    - name: "{{ recipe_name }}: Start niova-block-ctl process."
      vars:
          input_param: {
             'nisd_dev_size': '68719476736',
             'lookout_uuid': '',
             'alt_name': 'nisd{{item}}'
              }
      set_fact:
         get_nisd: "{{ lookup('nisd_handler', 'niova-block-ctl', input_param, wantlist=True) }}"
      loop: "{{ range(0, nnisds | int) }}"
      #no_log: True

    - name: "{{ recipe_name }}: Start nisd process."
      vars:
         input_param: {
                  'nisd_uuid' : '{{ get_nisd }}',
                  'uport' : '1053',
                  'lookout_uuid': ''
                  }
      debug:
         msg: "{{ lookup('nisd_handler', 'nisd', input_param, wantlist=True) }}"
      #no_log: True

    - pause:
        seconds: 2

    - name: "{{ recipe_name }}: Perform some Writes to the NISD form client 1."
      vars:
         input_param: {
                 'nisd_uuid_to_write' : 'unix:{{ get_nisd }}',
                 'vdev' : '{{ resourceUUID.stdout }}',
                 'read_operation_ratio_percentage' : '0',
                 'random_seed' : '123',
                 'client_uuid' : '{{ clientUUID1.stdout }}',
                 'request_size_in_bytes' : '32',
                 'queue_depth' : '1',
                 'num_ops' : '50',
                 'integrity_check' : True,
                 'sequential_writes' : False,
                 'blocking_process' : False,
                 'lookout_uuid': ''
                 }
      debug:
         msg: "{{ lookup('nisd_handler', 'niova-block-test', input_param, wantlist=True) }}"
    
  # TODo
  # validations from client1 that writes is complete

    - name: "{{ recipe_name }}: Perform some Writes to the NISD form client 2."
      vars:
         input_param: {
                 'nisd_uuid_to_write' : 'unix:{{ get_nisd }}',
                 'vdev' : '{{ resourceUUID.stdout }}',
                 'read_operation_ratio_percentage' : '0',
                 'random_seed' : '123',
                 'client_uuid' : '{{ clientUUID2.stdout }}',
                 'request_size_in_bytes' : '32',
                 'queue_depth' : '1',
                 'num_ops' : '50',
                 'integrity_check' : True,
                 'sequential_writes' : False,
                 'blocking_process' : False,
                 'lookout_uuid': ''
                 }
      debug:
         msg: "{{ lookup('nisd_handler', 'niova-block-test', input_param, wantlist=True) }}"

           # TODO
           # Client2 should not be able to perform any operation on NISD as it does not have the lease.
