- import_playbook: basic_process_ctl.yml
- name: "term_ticker"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "term_ticker"
     parent: "basic_process_ctl"
     peer_idx: 0
     get_all_arr: []

  tasks:
    - name: "Verify stage 0 rule table"
      vars:
         ctlreq_cmd0:
            cmd: "get_all"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage0"
            index: "{{ item }}"
            sleep_after: 3
         ctlreq_cmd1:
            cmd: "get_all"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage0"
            index: "{{ item + 1 }}"
      set_fact:
          term0="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/term', wantlist=True)}}"
          term1="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd1, '/raft_root_entry/*/term', wantlist=True)}}"
          voted_uuid="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/voted-for-uuid', wantlist=True)}}"
          leader_uuid="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/leader-uuid', wantlist=True)}}"
          commit_idx="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/commit-idx', wantlist=True)}}"
          last_applied="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/last-applied', wantlist=True)}}"
          crc="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/last-applied-cumulative-crc', wantlist=True)}}"
          state="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/state', wantlist=True)}}"
          follower_reason="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/follower-reason', wantlist=True)}}"
          client_req="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, '/raft_root_entry/*/client-requests', wantlist=True)}}"

      failed_when: >
        (term0[0] > term1[0]) and
        (voted_uuid[0] != "") and
        (leader_uuid[0] != "") and
        (commit_idx[0] != -1) and
        (last_applied[0] != -1) and
        (crc[0] != 0) and
        (state[0] != "candidate") and
        (follower_reason[0] != "none") and
        (client_req[0] != "deny-leader-not-established")
      loop: "{{ range(0, 5)| list }}"

    - name: "Copy get_all before killing process"
      vars:
         before_reboot_ctlreq_cmd:
            cmd: "get_all"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage1_before_reboot"
      set_fact: raft_json="{{lookup('niova_plugin', 'ctlrequest', recipe_params, before_reboot_ctlreq_cmd, wantlist=True)}}"

    - name: "Kill the process"
      set_fact: kill_peer0="{{lookup('niova_plugin', 'raftprocess', recipe_params, peer_idx, "kill", wantlist=True)}}"

    - name: "Restart the process"
      set_fact: start_peer0="{{lookup('niova_plugin', 'raftprocess', recipe_params, peer_idx, "start", wantlist=True)}}"

    - name: "Idle off cmd"
      vars:
        ctlreq_cmd:
           cmd: "idle_off"
           wait_for_ofile: True
           recipe_name: "{{ recipe_name }}"
           peer_id: "{{ peer_idx }}"
           stage: "pre_stage1"
      set_fact: idle_off="{{lookup('niova_plugin', 'ctlrequest', recipe_params, ctlreq_cmd, wantlist=True)}}"

    - name: "Verify Stage1 rule table"
      vars:
         before_reboot_ctlreq_cmd:
            cmd: "get_all"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage1_before_reboot"
            sleep_after: 3
         after_reboot_ctlreq_cmd:
            cmd: "get_all"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage1_after_reboot"
      set_fact: 
          before_reboot="{{lookup('niova_plugin', 'lookup_create', recipe_params, before_reboot_ctlreq_cmd, '/raft_root_entry/*/term', wantlist=True)}}"
          after_reboot="{{lookup('niova_plugin', 'lookup_create', recipe_params, after_reboot_ctlreq_cmd, '/raft_root_entry/*/term', wantlist=True)}}"

      failed_when:
        before_reboot[0] >= after_reboot[0]
        
