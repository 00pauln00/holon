- name: "Holon framework"
  hosts: localhost
  connection: local

  vars_files:
    - ./cmdline_vars.yml

  vars:
    # Default values
    dir_path: "/tmp/holon_recipes_run"
    port: 6000
    npeers: 5
    client_port: 13000

  tasks:

  - name: "Get Raft UUID"
    shell: "/usr/bin/uuid"
    register: cluster_uuid
  
  - name: "Prepare parameter to pass across recipes"
    set_fact:
       raft_param:
           base_dir: "{{ dir_path }}"
           raft_uuid: "{{ cluster_uuid.stdout}}"

  - name: "prepare config"
    vars:
      config_params:
        npeers: "{{ npeers }}"
        port: "{{ port }}"
        client_port: "{{ client_port }}"
    set_fact: raft_conf="{{lookup('niova_raftconfig', config_params, wantlist=True)}}"

  - name: "Show the values"
    debug:
      msg:
        - "Directory path: {{ dir_path }}"
        - "Port is {{ port }}"
        - "Nservers is: {{ npeers }}"
        - "client port is {{ client_port }}"
        - "Raft UUID is {{ cluster_uuid.stdout }}"
        - "Recipe: {{ recipe }}"
        - "Raft params: {{ raft_param }}"

- import_playbook: "{{ recipe }}"
  vars:
    recipe_params: "{{ raft_param }}"
