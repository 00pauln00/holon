- name: "basic_ctl_int"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_ctl_int"
     parent: None
     peer_idx: 0
     curr_time_arr: []

  tasks:
    - name: "Ctlreq for idle_on cmd"
      vars:
          ctlreq_cmd:
             cmd: "idle_on"
             wait_for_ofile: False
             recipe_name: "{{ recipe_name }}"
             peer_id: "{{ peer_idx }}"
             stage: "pre_stage0"
      set_fact: idle_on="{{lookup('niova_plugin', 'ctlrequest', recipe_params, ctlreq_cmd, wantlist=True)}}"

    - name: "Start peer 0"
      set_fact: server0="{{lookup('niova_plugin', 'raftprocess', recipe_params, peer_idx, 'start', wantlist=True)}}"

    - name: "Verify using lookup_and_create"
      vars:
         ctlreq_cmd:
            cmd: "get_all"
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage0"
         raft_keys:
            - "/raft_root_entry/*/leader-uuid"
            - "/raft_root_entry/*/commit-idx"
            - "/raft_root_entry/*/last-applied-cumulative-crc"
            - "/raft_root_entry/*/last-applied"
            - "/raft_net_info/ignore_timer_events"
      set_fact:
          raft_values="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd, raft_keys, wantlist=True)}}"
      failed_when: >
         (raft_values[0] != "null") or
         (raft_values[1] != "-1") or
         (raft_values[2] != "0") or
         (raft_values[3] != "-1") or
         (raft_values[4] != "True")

    - name: "Idleness off"
      vars:
         ctlreq_cmd:
            cmd: "idle_off"
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "pre_stage1"
      set_fact: idle_off="{{lookup('niova_plugin', 'ctlrequest', recipe_params, ctlreq_cmd, wantlist=True)}}"

    # Sleep after execution of the 1st ctlreq cmd.
    - name: "Verify stage1"
      vars:
         ctlreq_cmd0:
            cmd: "current_time"
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage1"
            index: "{{ item }}"
            sleep_after: 2
         ctlreq_cmd1:
            cmd: "current_time"
            recipe_name: "{{ recipe_name }}"
            peer_id: "{{ peer_idx }}"
            stage: "stage1"
            index: "{{ item + 1 }}"
         raft_key:
            - "/system_info/current_time"
      set_fact:
         curr_time0="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd0, raft_key, wantlist=True)}}"
         curr_time1="{{lookup('niova_plugin', 'lookup_create', recipe_params, ctlreq_cmd1, raft_key, wantlist=True)}}"
      failed_when: curr_time0[0] >= curr_time1[0]
      loop: "{{ range(0, 5)| list }}"
