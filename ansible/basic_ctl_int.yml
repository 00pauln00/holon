- name: "basic_ctl_int"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_ctl_int"
     parent: None

  tasks:
    - name: "Get the non-running peers list to select first peer to start"
      include_role:
        name: common
        tasks_from: get_server_uuid_info

    - name: "The first peer to start"
      set_fact:
       Server0UUID="{{non_running_peers[0]}}"

    - name: "Disable Raft timer thread"
      vars:
        stage: "idle_on"
        wait_for_ofile: False
        cmd: "ignore_timer_events@true"
        where: "/raft_net_info/ignore_timer_events"
        idle_on: "{{lookup('niova_ctlrequest', 'apply_cmd', Server0UUID, cmd, where, wantlist=True)}}"
      debug:
        msg: "{{ idle_on }}"

    - name: "Start peer which is made idle in previous task"
      include_role:
        name: common
        tasks_from: start_server
      vars:
        ServerUUID: "{{Server0UUID}}"

    - name: "Wait for server to start properly"
      wait_for:
         timeout: 7

    - name: "Verify Initial Idle condition"
      vars:
        stage: "stage0"
        raft_keys:
            - "/raft_root_entry/0/leader-uuid"
            - "/raft_root_entry/0/commit-idx"
            - "/raft_root_entry/0/last-applied-cumulative-crc"
            - "/raft_root_entry/0/last-applied"
            - "/raft_net_info/ignore_timer_events"
        raft_values: "{{lookup('niova_ctlrequest', 'lookup', Server0UUID, raft_keys, wantlist=True)}}"
      debug:
        msg: "{{raft_values}}"
      # Lookup the  value in the result using last two keys from the complete key path
      failed_when: >
         (raft_values["/0/leader-uuid"] != "null") or
         (raft_values["/0/commit-idx"] != -1) or
         (raft_values["/0/last-applied-cumulative-crc"] != 0) or
         (raft_values["/0/last-applied"] != -1) or
         (raft_values["/raft_net_info/ignore_timer_events"] == False)

    - name: "Activate Raft timer thread"
      vars:
         stage: "idle_off"
         cmd: "ignore_timer_events@false"
         where: "/raft_net_info/ignore_timer_events"
         idle_off: "{{lookup('niova_ctlrequest', 'apply_cmd', Server0UUID, cmd, where, wantlist=True)}}"
      debug:
        msg: "{{idle_off}}"

    - name: "Get the current time for the peer in loop"
      vars:
        stage: "stage1"
        iter_info:
           iter: 5
           sleep_after_cmd: 2
      set_fact:
        time_stamp: "{{lookup('niova_ctlrequest', 'lookup', Server0UUID, '/system_info/current_time', iter_info, wantlist=True)}}"

    - name: "verify stage1, current time should increament in each iteration"
      vars:
        orig_time: "{{time_stamp[item]['/system_info/current_time']}}"
        curr_time: "{{time_stamp[item + 1]['/system_info/current_time']}}"
      debug:
         msg: "Compare time stamp: {{ orig_time }} with {{ curr_time }}"
      failed_when: orig_time >= curr_time
      loop: "{{ range(0, 4)| list }}"
