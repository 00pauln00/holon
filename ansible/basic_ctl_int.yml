- name: "basic_ctl_int"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_ctl_int"
     parent: None
     peer_idx: 0

  tasks:
    - name: "Ctlreq for idle_on cmd"
      vars:
          ctlreq_cmd:
             cmd: "idle_on"
             wait_for_ofile: False
             recipe_name: "{{ recipe_name }}"
             stage: "pre_stage0"
             src: "src1"
      set_fact: raft_json="{{lookup('niova_plugin', "ctlrequest", recipe_params, peer_idx, ctlreq_cmd, wantlist=True)}}"

    - name: "Start peer 0"
      set_fact: raft_json="{{lookup('niova_plugin', 'raftprocess', recipe_params, peer_idx, "start", wantlist=True)}}"

    - name: "Copy the get_all cmd to verify stage0"
      vars:
         ctlreq_cmd:
             cmd: "get_all"
             wait_for_ofile: True
             recipe_name: "{{ recipe_name }}"
             stage: "stage0"
             src: "src1"
      set_fact: raft_json="{{lookup('niova_plugin', 'ctlrequest', recipe_params, peer_idx, ctlreq_cmd, wantlist=True)}}"

    - name: "Verify stage 0 rule table"
      vars:
           stage0_rule_table:
              rule1:
                key1: "/raft_root_entry/*/leader-uuid"
                expected_val: "null"
                data_type: "string"
                operator: "=="
              rule2:
                 key1: "/raft_root_entry/*/commit-idx"
                 expected_val: "-1"
                 data_type: "int"
                 operator: "=="
              rule3:
                 key1: "/raft_root_entry/*/last-applied"
                 expected_val: "-1"
                 data_type: "int"
                 operator: "=="
              rule4:
                 key1: "/raft_root_entry/*/last-applied-cumulative-crc"
                 expected_val: "0"
                 data_type: "int"
                 operator: "=="
              rule5:
                 key1: "/raft_net_info/ignore_timer_events"
                 expected_val: "True"
                 data_type: "bool"
                 operator: "=="
           compare_sources:
               src1: "{{ recipe_name }}/stage0/src1"

      set_fact: result="{{lookup('niova_plugin', 'recipe_verify', recipe_params, compare_sources, stage0_rule_table, wantlist=True)}}"

    - name: "Idleness off"
      vars:
         ctlreq_cmd:
            cmd: "idle_off"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            stage: "pre_stage1"
            src: "src1"
      set_fact: idle_off="{{lookup('niova_plugin', 'ctlrequest', recipe_params, peer_idx, ctlreq_cmd, wantlist=True)}}"

    - name: "Get current_time in a loop with sleep of 1sec in between"
      vars:
         ctlreq_cmd:
            cmd: "current_time"
            wait_for_ofile: True
            recipe_name: "{{ recipe_name }}"
            stage: "stage1"
            src: "src1"
      set_fact: curr_time="{{lookup('niova_plugin', 'ctlrequest', recipe_params, peer_idx, ctlreq_cmd, wantlist=True)}}"
      loop: "{{ range(0, 5)| list }}"
      loop_control:
          pause: 1

    - name: "Verify Stage1 rule table"
      vars:
         stage1_rule_table:
            rule1:
               key1: "/system_info/current_time"
               key2: "/system_info/current_time"
               data_type: "time"
               operator: "<"
         compare_sources:
            src1: "{{ recipe_name }}/stage1/src1"
      set_fact: result="{{lookup('niova_plugin', 'recipe_verify', recipe_params, compare_sources, stage1_rule_table, wantlist=True)}}"
