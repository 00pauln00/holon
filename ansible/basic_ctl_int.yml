- name: "basic_ctl_int"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_ctl_int"
     parent: None
     peerid0: 0
     curr_time_arr: []

  tasks:
    - name: "Ctlreq for idle_on cmd"
      vars:
        stage: "idle_on"
      set_fact: idle_on="{{lookup('niova_ctlrequest', 'create_cmd', "idle_on", peerid0, False, wantlist=True)}}"

    - name: "Start peer 0"
      set_fact: server0="{{lookup('niova_raftprocess', 'start', peerid0, wantlist=True)}}"

    - name: "Verify using lookup_and_create"
      vars:
        stage: "stage0"
        raft_keys:
            - "/raft_root_entry/*/leader-uuid"
            - "/raft_root_entry/*/commit-idx"
            - "/raft_root_entry/*/last-applied-cumulative-crc"
            - "/raft_root_entry/*/last-applied"
            - "/raft_net_info/ignore_timer_events"
      set_fact:
          raft_values="{{lookup('niova_ctlrequest', 'lookup', 'get_all', peerid0, raft_keys, wantlist=True)}}"
      # Lookup the  value in the result using last two keys from the complete key path
      failed_when: >
         (raft_values["/*/leader-uuid"] != "null") or
         (raft_values["/*/commit-idx"] != -1) or
         (raft_values["/*/last-applied-cumulative-crc"] != 0) or
         (raft_values["/*/last-applied"] != -1) or
         (raft_values["/raft_net_info/ignore_timer_events"] != True)

    - name: "Idleness off"
      vars:
         stage: "idle_off"
      set_fact: idle_off="{{lookup('niova_ctlrequest', 'create_cmd', 'idle_off', peerid0, False, wantlist=True)}}"

    - name: "Get the current time for the peer in loop"
      vars:
        stage: "stage1"
        raft_key:
           - "/system_info/current_time"
        iter_info:
           iter: 5
           sleep_after_cmd: 2
      set_fact:
          curr_time_arr="{{ lookup('niova_ctlrequest', 'lookup', 'current_time', peerid0, raft_key, iter_info, wantlist=True)}}"

    - name: "verify stage1, current time should increament in each iteration"
      vars:
        orig_time: "{{curr_time_arr[item]['/system_info/current_time']}}"
        curr_time: "{{curr_time_arr[item + 1]['/system_info/current_time']}}"
      debug:
         msg: "Compare time stamp: {{ orig_time }} with {{ curr_time }}"
      failed_when: orig_time >= curr_time
      loop: "{{ range(0, 4)| list }}"
