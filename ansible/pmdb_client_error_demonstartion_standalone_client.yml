- name: "PMDB Client Error Demostration"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "pmdb_client_error_demonstartion_standalone_client"
     parent: None
     # XXX we should change hardcoded path later.
     pmdb_client_path: "/home/pauln/raft-builds/latest/pumicedb-client-test"
     raft_client_path: "/home/pauln/raft-builds/latest/raft-client"
  tasks:
  - name: "Extract the Base directory path and Raft UUID."
    set_fact:
      raft_uuid="{{ raft_conf | json_query('raft_uuid')}}"

  - name: "Generate client UUID"
    shell: "/usr/bin/uuid"
    register: cuuid

  - name: "Get client uuid"
    set_fact:
      client_uuid: "{{cuuid.stdout}}"

  - debug:
      msg:
        - "{{raft_uuid}}"
        - "{{client_uuid}}"

  - name: "Get truncated UUIDs"
    set_fact:
      truncate_ruuid="{{raft_uuid[:-1]}}"
      truncate_cuuid="{{client_uuid[:-1]}}" 

  - debug: var=truncate_ruuid
  - debug: var=truncate_cuuid
    
  - name: "Starting the Raft client with wrong Raft UUID and Client UUID."
    command:
      argv:
        - "{{raft_client_path}}"
        - -r
        - "{{truncate_ruuid}}"
        - -u
        - "{{truncate_ruuid}}"
    register: raft_output
    failed_when: raft_output.rc != 22
  - debug: var=raft_output.rc

  - name: "Starting the pumicedb client with wrong Raft UUID and Client UUID."
    command:
      argv:
        - "{{pmdb_client_path}}"
        - -r
        - "{{truncate_ruuid}}"
        - -u
        - "{{truncate_ruuid}}"
    register: pmdb_output
    failed_when: pmdb_output.rc == 0
  - debug: var=pmdb_output.rc

  - name: "Ensure that raft client fails when '-u' is not passed"
    command:
      argv:
        - "{{raft_client_path}}"
        - -r
        - "{{raft_uuid}}"
    register: ruuid_result
    failed_when: ruuid_result.rc == 0
  - debug: var=ruuid_result.rc

  - name: "Ensure that raft client fails when '-r' is not passed."
    command:
      argv:
        - "{{raft_client_path}}"
        - -u
        - "{{client_uuid}}"
    register: cuuid_result
    failed_when: cuuid_result.rc == 0
  - debug: var=cuuid_result.rc

  - name: "Ensure that pumicedb client fails when '-u' is not passed."
    command:
      argv:
        - "{{pmdb_client_path}}"
        - -r
        - "{{raft_uuid}}"
    register: ruuid_return
    failed_when: ruuid_return.rc == 0
  - debug: var=ruuid_return.rc

  - name: "Ensure that pumicedb client fails when '-r' is not passed."
    command:
      argv:
        - "{{pmdb_client_path}}"
        - -u
        - "{{client_uuid}}"
    register: cuuid_return
    failed_when: cuuid_return.rc == 0
  - debug: var=cuuid_return.rc
  
  - name: "Run with raft-client by passing client uuid which is not known to the configuration."
    command:
      argv:
        - "{{raft_client_path}}"
        - -r
        - "{{raft_uuid}}"
        - -u
        - "{{client_uuid}}"
    register: raftclient_output
    failed_when: raftclient_output.rc != 2
  - debug: var=raftclient_output.rc

  - name: "Run with pmdb-client by passing client uuid which is not known to the configuration."
    command:
      argv:
        - "{{pmdb_client_path}}"
        - -r
        - "{{raft_uuid}}"
        - -u
        - "{{client_uuid}}"
    register: pmdbclient_output
    failed_when: pmdbclient_output.rc == 0
  - debug: var=pmdbclient_output.rc
