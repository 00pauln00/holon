- import_playbook: term_ticker.yml
- name: "term_catch_up"
  hosts: localhost
  connection: local
  vars:
     parent: "term_ticker"
     recipe_name: "term_catch_up"
     peer_idx0: 0
     peer_idx1: 1
     iterations: 5
  
  #Start Peer1
  tasks:
    - name: "Start peer 1"
      set_fact: server0="{{lookup('niova_raftprocess', 'start', peer_idx1, wantlist=True)}}"

    #Copy get_term in peer1 and in peer0, Pause and Resume peer0 in loop and compare its term catches up peer1 term
    - name: "Pause peer0, copy get_all for peer1, resume peer0, copy get_all for peer0, verify stage 1"
      vars:
        stage: "stage1"
        iter_info:
          iter: 1
          sleep_after_cmd: 2
        term_key:
          - "/raft_root_entry/*/term"
      set_fact:
         pause_peer0="{{lookup('niova_raftprocess', 'pause', peer_idx0, wantlist=True)}}"
         peer1_term="{{lookup('niova_ctlrequest', 'lookup', 'get_term', peer_idx1, term_key, iter_info, wantlist=True)}}"
         resume_peer0="{{lookup('niova_raftprocess', 'resume', peer_idx0, wantlist=True)}}"
         peer0_term="{{lookup('niova_ctlrequest', 'lookup', 'get_term', peer_idx0, term_key, wantlist=True)}}"
      failed_when: peer1_term > peer0_term
      loop: "{{ range(0, iterations)| list }}"
      loop_control:
        pause: 2
