- import_playbook: basic_ctl_int.yml
- name: "basic_process_ctl"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_process_ctl"
     parent: "basic_ctl_int"
     iterations: 5
     timestamp: []

  tasks:
    - name: "Pause an resume peer0 in a loop"
      vars:
        stage: "stage0"
      set_fact:
         pause_peer0="{{lookup('niova_raftprocess', 'pause', 0, wantlist=True)}}"
         curr_time_peer0="{{lookup('niova_ctlrequest', 'apply_cmd', 0, 'current_time', False, wantlist=True)}}"
         resume_peer0="{{lookup('niova_raftprocess', 'resume', 0, wantlist=True)}}"
      loop: "{{ range(0, iterations)| list }}"
      loop_control:
        pause: 5
    
    - name: "Get the timestamp for peer0 in a loop with gap of 2secs"
      vars:
        stage: "stage1"
        iter_info:
           iter: 5
           sleep_after_cmd: 2
      set_fact:
          timestamp="{{ lookup('niova_ctlrequest', 'lookup', 0, '/system_info/current_time', iter_info, wantlist=True)}}"

    - name: "verify stage1: timestamp should be incremental in each iteration"
      vars:
        time1: "{{timestamp[item]['/system_info/current_time']}}"
        time2: "{{timestamp[item + 1]['/system_info/current_time']}}"
      debug:
         msg: "Compare time stamp: {{ time1 }} with {{ time2 }}"
      failed_when: time1 >= time2
      loop: "{{ range(0, (iterations - 1))| list }}"
