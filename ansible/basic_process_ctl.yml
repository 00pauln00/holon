- import_playbook: basic_ctl_int.yml
- name: "basic_process_ctl"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_process_ctl"
     parent: "basic_ctl_int"
     peerid0: 0
     iterations: 5
     curr_time_arr: []

  tasks:
    - name: "Pause peer 0, get current_time and resume peer 0"
      vars:
        stage: "stage0"
      set_fact:
         pause_peer0="{{lookup('niova_raftprocess', 'pause', peerid0, wantlist=True)}}"
         curr_time_peer0="{{lookup('niova_ctlrequest', 'create_cmd', 'current_time', peerid0, False, wantlist=True)}}"
         resume_peer0="{{lookup('niova_raftprocess', 'resume', peerid0, wantlist=True)}}"
      loop: "{{ range(0, iterations)| list }}"
      loop_control:
        pause: 5
    
    - name: "Get the current time for the peer in loop"
      vars:
        stage: "stage1"
        raft_key:
           - "/system_info/current_time"
        iter_info:
           iter: 5
           sleep_after_cmd: 2
      set_fact:
          curr_time_arr="{{ lookup('niova_ctlrequest', 'lookup', 'current_time', peerid0, raft_key, iter_info, wantlist=True)}}"

    - name: "verify stage1, current time should increament in each iteration"
      vars:
        orig_time: "{{curr_time_arr[item]}}"
        curr_time: "{{curr_time_arr[item + 1]}}"
      debug:
         msg: "Compare time stamp: {{ orig_time }} with {{ curr_time }}"
      failed_when: orig_time >= curr_time
      loop: "{{ range(0, (iterations - 1))| list }}"
