- import_playbook: basic_ctl_int.yml
- name: "basic_process_ctl"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "basic_process_ctl"
     parent: "basic_ctl_int"
     iterations: 5

  tasks:
    - name: "Pause and resume peer0 in a loop"
      vars:
        stage: "stage0"
        wait_for_ofile: False
      set_fact:
        pause_peer0="{{ lookup('niova_raftprocess', 'pause', Server0UUID, wantlist=True) }}"
        curr_time_peer0="{{ lookup('niova_ctlrequest', 'lookup', Server0UUID, '/system_info/current_time', wantlist=True) }}"
        resume_peer0="{{ lookup('niova_raftprocess', 'resume', Server0UUID, wantlist=True) }}"
      loop: "{{ range(0, iterations)| list }}"
      loop_control:
        pause: 5
    
    - name: "Get the timestamp for peer0 in a loop with gap of 2secs"
      vars:
        stage: "stage1"
        iter_info:
           iter: 5
           sleep_after_cmd: 2
      set_fact:
          time_stamp="{{ lookup('niova_ctlrequest', 'lookup', Server0UUID, '/system_info/current_time', iter_info, wantlist=True) }}"

    - name: "verify stage1: timestamp should be incremental in each iteration"
      vars:
        time1: "{{ time_stamp[item]['/system_info/current_time'] }}"
        time2: "{{ time_stamp[item + 1]['/system_info/current_time'] }}"
      debug:
         msg: "Compare time stamp: {{ time1 }} with {{ time2 }}"
      failed_when: time1 >= time2
      loop: "{{ range(0, (iterations - 1))| list }}"
