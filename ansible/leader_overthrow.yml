- import_playbook: basic_leader_election.yml
- name: "leader_overthrow"
  hosts: localhost
  connection: local
  vars:
     recipe_name: "leader_overthrow"
     parent: "basic_leader_election"
     follower_uuid: []

  tasks:
    - name: "Get the latest list of running peer UUIDs"
      include_role:
        name: common
        tasks_from: get_server_uuid_info
    
    - name: "Get the raft values for all running peers"
      vars:
         stage: "stage0_get_all"
         raft_keys:
            - "/raft_root_entry/0/leader-uuid"
            - "/raft_root_entry/0/term"
            - "/raft_root_entry/0/commit-idx"
            - "/raft_root_entry/0/newest-entry-idx"
            - "/raft_root_entry/0/newest-entry-term"
            - "/raft_root_entry/0/newest-entry-crc"
            - "/raft_root_entry/0/newest-entry-data-size"
            - "/raft_root_entry/0/state"
            - "/raft_root_entry/0/last-applied"
            - "/raft_root_entry/0/last-applied-cumulative-crc"
            - "/raft_root_entry/0/peer-uuid"
      set_fact:
          stage0_values="{{lookup('niova_ctlrequest', 'lookup', nrunning_peers[item], raft_keys, wantlist=True)}}"
      loop: "{{ range(0, nrunning_peers|length) | list }}"

    - name: "Get the list of peers in the cluster"
      set_fact:
        peer_arr="{{ raft_conf | json_query('peer_uuid_dict')}}"    

    - name: "Get peer uuid for the leader"
      set_fact:
        leader_uuid: "{{item.value}}"
      when: stage0_values["/0/leader-uuid"] == item.value 
      with_dict: "{{ peer_arr }}"

    - name: "Get corresponding UUIDs for follower peers"
      set_fact:
         follower_uuid: "{{ follower_uuid + [item.value] }}"
      when: stage0_values["/0/leader-uuid"] != item.value
      with_dict: "{{ peer_arr }}"

    - name: "Disable message receive on all peers for leader overthrow"
      vars:
         stage: "stage1_rcv_false"
         cmd: "net_recv_enabled@false"
         where: "/ctl_svc_nodes/net_recv_enabled@true"
      set_fact: recv_false="{{lookup('niova_ctlrequest', 'apply_cmd', nrunning_peers[item], cmd, where, wantlist=True)}}"
      loop: "{{ range(0, nrunning_peers|length) | list }}"

    - pause: seconds=3

    - name: "Verify that message received is disabled successfully on all peers"
      vars:
         stage: "stage1_get_all"
         raft_keys:
             - "/ctl_svc_nodes/*/net_recv_enabled"
             - "/raft_root_entry/0/leader-uuid"
             - "/raft_root_entry/0/state"
             - "/raft_root_entry/0/client-requests"
             - "/raft_root_entry/0/term"
      set_fact:
          net_rcv="{{lookup('niova_ctlrequest', 'lookup', nrunning_peers[item], raft_keys, wantlist=True)}}"
      failed_when: >
           (net_rcv["/*/net_recv_enabled"] != False) or
           (net_rcv["/0/leader-uuid"] != stage0_values["/0/leader-uuid"]) or
           ((net_rcv["/0/state"] != "leader") and
           (net_rcv["/0/state"] != "candidate")) or
           ((net_rcv["/0/client-requests"] != "deny-may-be-deposed") and
           (net_rcv["/0/client-requests"] != "deny-leader-not-established")) or
           ((net_rcv["/0/term"] != stage0_values["/0/term"]) and
           (net_rcv["/0/term"] <= stage0_values["/0/term"]))
      loop: "{{ range(0, nrunning_peers|length) | list }}"
    - name: "Lets sleep for sometime before checking the values"
      wait_for:
        timeout: 5

    - name: "Selected leader-to-be"
      debug:
        msg: "{{ follower_uuid[0] }}"

    - name: "Set leader-to-be on all peers"
      vars:
         stage: "stage2_set_leader"
         cmd: "net_recv_enabled@true"
         where: "/ctl_svc_nodes/uuid@{{ follower_uuid[0] }}"
      set_fact: set_leader_id="{{lookup('niova_ctlrequest', 'apply_cmd', nrunning_peers[item], cmd, where, wantlist=True)}}"
      loop: "{{ range(0, nrunning_peers|length) | list }}"

    - pause: seconds=3

    - name: "Verify that leader-to-be is not elected yet"
      vars:
         stage: "stage2_set_leader"
         raft_keys:
            - "/raft_root_entry/0/leader-uuid"
            - "/raft_root_entry/0/commit-idx"
            - "/raft_root_entry/0/last-applied"
            - "/raft_root_entry/0/last-applied-cumulative-crc"
            - "/raft_root_entry/0/term"
            - "/raft_root_entry/0/newest-entry-term"
            - "/raft_root_entry/0/newest-entry-crc"
            - "/raft_root_entry/0/newest-entry-data-size"
            - "/raft_root_entry/0/newest-entry-idx"
            - "/raft_root_entry/0/state"
            - "/raft_root_entry/0/client-requests"
            - "/raft_root_entry/0/voted-for-uuid"
            - "/raft_root_entry/0/peer-uuid"
      set_fact:
          set_leader="{{lookup('niova_ctlrequest', 'lookup', nrunning_peers[item], raft_keys, wantlist=True)}}"
      failed_when: >
        (set_leader["/0/leader-uuid"] != stage0_values["/0/leader-uuid"]) or
        (set_leader["/0/commit-idx"] != stage0_values["/0/commit-idx"]) or
        (set_leader["/0/last-applied"] != stage0_values["/0/last-applied"]) or
        (set_leader["/0/last-applied-cumulative-crc"] != stage0_values["/0/last-applied-cumulative-crc"]) or
        (set_leader["/0/term"] <= stage0_values["/0/term"]) or
        (set_leader["/0/newest-entry-term"] != stage0_values["/0/newest-entry-term"]) or
        (set_leader["/0/newest-entry-crc"] != stage0_values["/0/newest-entry-crc"]) or
        (set_leader["/0/newest-entry-data-size"] != stage0_values["/0/newest-entry-data-size"]) or
        (set_leader["/0/newest-entry-idx"] != stage0_values["/0/newest-entry-idx"]) or
        (set_leader["/0/state"] != "candidate") or
        (set_leader["/0/client-requests"] != "deny-leader-not-established") or
        (set_leader["/0/voted-for-uuid"] != set_leader["/0/peer-uuid"]) 
      loop: "{{ range(0, nrunning_peers|length) | list }}"
    - pause: seconds=3
    - name: "Enable message receive on peer which is leader-to-be"
      vars:
         stage: "stage3_rcv_true"
         cmd: "net_recv_enabled@true"
         where: "/ctl_svc_nodes/net_recv_enabled@false"
      set_fact: recv_true="{{lookup('niova_ctlrequest', 'apply_cmd', follower_uuid[0], cmd, where, wantlist=True)}}"

    - name: "Verify new leader is elected successfully"
      vars:
         stage: "stage4_get_all"
         raft_key:
            - "/raft_root_entry/0/leader-uuid"
            - "/raft_root_entry/0/voted-for-uuid"
      set_fact:
          new_leader_election="{{lookup('niova_ctlrequest', 'lookup', follower_uuid[0], raft_key, wantlist=True)}}"
      until: new_leader_election["/0/leader-uuid"] == new_leader_election["/0/voted-for-uuid"]
      retries: 10
      delay: 2
      ignore_errors: yes
      loop: "{{ range(0, 5) | list }}"
      loop_control:
          pause: 2
